{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Options</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/index.css' %}">
</head>
<body class="bg-light">
<div class="container-fluid main-panel py-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
        <button id="backButton" type="button" class="btn btn-outline-secondary btn-icon">Retour</button>
        <h1 class="h5 text-dark mb-0">Options</h1>
        <div class="btn-placeholder"></div>
    </div>

    <p class="text-muted small mb-2">
        Désactivez un radiateur pour forcer en permanence le mode Éco. Les radiateurs désactivés ne répondront plus aux commandes depuis la page principale tant qu'ils ne sont pas réactivés ici.
    </p>

    <div class="alert alert-info py-2 px-3 small mb-3">
        <strong>Serveur MQTT&nbsp;:</strong> {{ mqtt_host }}
    </div>

    <div id="statusMessage" class="alert d-none" role="alert"></div>

    <div class="card option-card mb-3">
        <div class="card-body">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-3 gap-2">
                <div>
                    <h2 class="h6 mb-1">Ajouter un appareil</h2>
                    <p class="option-description mb-0">Renseignez l'identifiant MQTT de l'ESP8266 ainsi que son adresse IP locale pour l'enregistrer dans l'application.</p>
                </div>
            </div>
            <form id="addDeviceForm" class="row g-2">
                <div class="col-md-6">
                    <label for="deviceName" class="form-label small text-muted mb-1">Nom MQTT</label>
                    <input type="text" class="form-control" id="deviceName" maxlength="64" required>
                </div>
                <div class="col-md-6">
                    <label for="deviceIp" class="form-label small text-muted mb-1">Adresse IP locale (optionnel)</label>
                    <input type="text" class="form-control" id="deviceIp" placeholder="192.168.x.x">
                </div>
                <div class="col-12 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Ajouter l'appareil</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card option-card mb-3">
        <div class="card-body">
            <h2 class="h6 mb-3">Appareils ajoutés depuis cette interface</h2>
            {% if custom_devices %}
                <ul class="list-group list-group-flush">
                    {% for device in custom_devices %}
                        <li class="list-group-item d-flex justify-content-between align-items-start px-0">
                            <div>
                                <strong>{{ device.name }}</strong>
                                {% if device.ip_address %}
                                    <div class="text-muted small">IP&nbsp;: {{ device.ip_address }}</div>
                                {% endif %}
                            </div>
                            <span class="badge text-bg-light">Ajouté le {{ device.added_at_display }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted mb-0">Aucun appareil supplémentaire n'a encore été enregistré.</p>
            {% endif %}
        </div>
    </div>

    {% for radiator, is_disabled in radiator_options %}
        <div class="card option-card mb-3">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <h2 class="h6 mb-1">{{ radiator }}</h2>
                    <p class="option-description mb-0">Forcer le mode Éco en permanence</p>
                </div>
                <div class="form-check form-switch m-0">
                    <input class="form-check-input radiator-toggle" type="checkbox" role="switch" id="toggle-{{ forloop.counter0 }}" data-radiator="{{ radiator }}" {% if is_disabled %}checked{% endif %}>
                    <label class="form-check-label visually-hidden" for="toggle-{{ forloop.counter0 }}">Désactiver {{ radiator }}</label>
                </div>
            </div>
        </div>
    {% empty %}
        <div class="alert alert-warning" role="alert">
            Aucun radiateur n'est configuré pour le moment.
        </div>
    {% endfor %}
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showMessage(type, message) {
        const container = document.getElementById('statusMessage');
        container.className = 'alert alert-' + type;
        container.textContent = message;
    }

    document.querySelectorAll('.radiator-toggle').forEach((toggle) => {
        toggle.addEventListener('change', function () {
            const radiator = this.dataset.radiator;
            const disabled = this.checked;
            fetch('/options/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({ radiator, disabled }),
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error('Request failed');
                    }
                    return response.json();
                })
                .then(() => {
                    showMessage('success', disabled
                        ? `${radiator} est maintenant en mode Éco forcé.`
                        : `${radiator} peut de nouveau changer de mode.`);
                })
                .catch(() => {
                    this.checked = !disabled;
                    showMessage('danger', `Impossible de mettre à jour ${radiator}. Réessayez plus tard.`);
                });
        });
    });

    document.getElementById('backButton').addEventListener('click', () => {
        window.location.href = '/';
    });

    const addDeviceForm = document.getElementById('addDeviceForm');
    if (addDeviceForm) {
        addDeviceForm.addEventListener('submit', (event) => {
            event.preventDefault();
            const nameInput = document.getElementById('deviceName');
            const ipInput = document.getElementById('deviceIp');
            const name = (nameInput.value || '').trim();
            const ipAddress = (ipInput.value || '').trim();

            if (!name) {
                showMessage('warning', 'Veuillez indiquer un nom pour le radiateur.');
                nameInput.focus();
                return;
            }

            showMessage('info', `Ajout de ${name} en cours…`);

            fetch('/devices/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: JSON.stringify({
                    name,
                    ip_address: ipAddress || undefined,
                }),
            })
                .then((response) => {
                    if (!response.ok) {
                        return response.json().then((data) => {
                            throw new Error(data.error || 'Impossible d\'ajouter cet appareil.');
                        });
                    }
                    return response.json();
                })
                .then(() => {
                    showMessage('success', `${name} a été ajouté. La page va se recharger.`);
                    setTimeout(() => window.location.reload(), 800);
                })
                .catch((error) => {
                    showMessage('danger', error.message || 'Impossible d\'ajouter cet appareil.');
                });
        });
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
